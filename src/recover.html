<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Recover Your Vault - Memoro Vault</title>
  <script src="libs/zip.min.js"></script>
  <script type="module">
  import init, {
    sha256_hash,
    aes_gcm_encrypt,
    aes_gcm_decrypt,
    argon2_derive
  } from "./wasm/memoro_crypto.js";

  window.initCryptoWasm = async () => {
    await init();
    window.sha256Hash       = (u8) => Promise.resolve(sha256_hash(u8));
    window.aesEncryptRust   = (k,n,p) => Promise.resolve(aes_gcm_encrypt(k,n,p));
    window.aesDecryptRust   = (k,n,c) => Promise.resolve(aes_gcm_decrypt(k,n,c));
    window.argon2DeriveRust = (pwdBytes, saltBytes, t, m, p, len) =>
      argon2_derive(pwdBytes, saltBytes, t, m, p, len);
  };

  window.initCryptoWasm();
</script>

  <link id="theme-cypherpunk" rel="stylesheet" href="css/recover_cypherpunk.css">
  <link id="theme-clean"       rel="stylesheet" href="css/recover_clean.css" disabled>

<script>
  // Theme switcher for recover page
  function applyRecoverTheme(theme) {
    const cy = document.getElementById('theme-cypherpunk');
    const cl = document.getElementById('theme-clean');
    const isCypher = (theme === 'cypherpunk');

    if (cy) cy.disabled = !isCypher;
    if (cl) cl.disabled =  isCypher;

    const setBodyAttr = () => {
      if (document.body) {
        document.body.setAttribute('data-theme', isCypher ? 'cypherpunk' : 'clean');
      }
    };
    if (document.readyState === 'loading') {
      window.addEventListener('DOMContentLoaded', setBodyAttr, { once: true });
    } else {
      setBodyAttr();
    }

    // Matrix control (defined later at bottom of file)
    if (window.RecoverMatrix) {
      if (isCypher) RecoverMatrix.start();
      else RecoverMatrix.stop();
    }
  }

  (function initRecoverTheme(){
const saved =
  sessionStorage.getItem('theme') ??
  localStorage.getItem('theme') ??
  'cypherpunk';
  window.__savedRecoverTheme = saved;

  const cy = document.getElementById('theme-cypherpunk');
  const cl = document.getElementById('theme-clean');
  const isCypher = (saved === 'cypherpunk');
  if (cy) cy.disabled = !isCypher;
  if (cl) cl.disabled =  isCypher;
})();
</script>

</head>
<body>
  <!-- Main heading -->
<h1 id="pageTitle">Recover Your Vault</h1>

<!-- Form for entering recovery answers -->
<form class="recovery-form" id="recoveryForm"></form>

<!-- Button to submit recovery -->
<div class="button-container">
  <button class="button" onclick="submitRecovery()">Recover Vault</button>
</div>

<!-- Modal for displaying recovered vault contents and donation prompt -->
<div id="seedModal" class="modal">
  <div class="modal-content">
    <div class="pow-section">
      <div class="donation-heading">Support Memoro Vault</div>
      <img src="assets/Screenshot (691).png" alt="Monero Donation QR" class="donation-qr">
      <p class="donation-text">
        <span class="donation-strong">Thanks for using Memoro Vault.</span><br>
        If you find it valuable, consider sending a small tip in XMR or your preferred cryptocurrency.
      </p>
      <button class="donation-button" type="button" onclick="donatePreferredCrypto()">
        Donate with preferred crypto
      </button>
    </div>

    <div class="pow-section">
      <h2 id="vaultRecoveredHeading" class="vault-recovered">Vault Recovered!</h2>
      <pre id="recoveredSeed" class="recovered-seed"></pre>
      <pre id="finalMessage" class="final-message"></pre>
    </div>
  </div>
</div>

<!-- Modal for file preview -->
<div id="previewModal" class="modal">
  <div class="modal-content">
    <h2 id="previewTitle">File Preview</h2>
    <div id="previewContent" class="preview-content"></div>
    <div class="modal-buttons">
      <button onclick="closePreview()">Close</button>
    </div>
  </div>
</div>

<!-- Proof-of-work overlay -->
<div id="powOverlay">
  <div id="powMessage">Checking answers... please wait</div>
  <div id="powTerminal"></div>
  <div class="progress-label">Processing...</div>
  <div class="progress-bar-container">
    <div class="progress-bar-fill" id="progressBar"></div>
  </div>
</div>

<!-- Red Herring instruction modal -->
<div id="redHerringModal" class="modal">
  <div class="modal-content">
    <h2 id="redHerringTitle" class="red-herring-title">Pay Attention Before You Begin</h2>
    <p id="redHerringText" class="red-herring-text">
  One of these questions might be a 
  <span class="red-herring-highlight">Red Herring</span>
  — a trick question that’s <u class="underline-strong">not supposed to be answered correctly</u>.
  <br><br>
  If a Red Herring is present, you must 
  <span class="leave-blank">leave it blank</span>. 
  Entering an answer—even the real one—will prevent you from unlocking the vault.
  <br><br>
  <span class="red-herring-highlight">How do I spot it?</span><br>
  • For text-entry questions: check the character hint beneath each question. 
  If the expected character count <u class="underline-strong">differs from the real answer by 2 or more characters</u>, it’s likely the Red Herring.<br>
  • For multiple-choice (MCQ) questions: if none of the options are correct, it is likely the Red Herring and <u class="underline-strong">must be left unanswered</u>.
  <br><br>
  <span class="example-label">Example:</span> If your favorite dog’s name was 
  “<code class="example-code">Samantha</code>” (8 letters), but the hint only shows 4 characters, 
  <u class="underline-strong">do not answer that question</u>.
  <br><br>
  There is either 
  <span class="exactly-one">exactly one</span> Red Herring 
  or <span class="exactly-one">none at all</span>—never more than one.
</p>
    <div class="modal-buttons">
      <button onclick="closeRedHerringModal()">Got it</button>
    </div>
  </div>
</div>

<!-- Matrix effect canvas and overlays -->
<canvas id="matrixCanvas"></canvas>
<div class="overlay" id="matrixOverlay"></div>
<div id="vaultCrackOverlay"></div>
<div id="crackOverlay"></div>
<div id="burstFlash"></div>

<!-- Toast notification -->
<div id="toast" class="toast"></div>

<!-- Spacers (unchanged) -->
<div class="spacer"></div><div class="spacer2"></div><div class="spacer3"></div><div class="spacer4"></div>
<div class="spacer5"></div><div class="spacer6"></div><div class="spacer7"></div><div class="spacer8"></div>
<div class="spacer9"></div><div class="spacer10"></div>

<script type="module" src="js/recover.js"></script>

</body>
</html>