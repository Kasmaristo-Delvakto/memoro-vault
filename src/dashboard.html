<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Memoro Vault - Dashboard</title>
<script src="libs/zip.min.js"></script>
<script src="libs/secrets.min.js"></script>
<!-- ZXing first (some polyfills will use it internally) -->
<script src="libs/zxing.min.js"></script>

<!-- Use the official WICG polyfill you downloaded -->
<script src="./libs/barcode-detector.polyfill.js"></script>
<script>
  // Force local file, no network
  if (window.setZXingModuleOverrides) {
    window.setZXingModuleOverrides({
      locateFile: (filename/* e.g. zxing_reader.wasm */) => `./libs/reader/${filename}`
    });
  }
  // Optional: eagerly init if you want
  if (window.prepareZXingModule) {
    window.prepareZXingModule({ overrides: { locateFile: f => `./libs/reader/${f}` }});
  }
</script>

<script>
// The polyfill defines window.BarcodeDetector automatically if the
// native API is missing. No manual assignment needed here.
</script>
<!-- PDF.js core -->
<script src="libs/pdf.min.js"></script>
<script>
  // Configure PDF.js to use the worker from your local libs folder
  if (window['pdfjsLib']) {
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'libs/pdf.worker.min.js';
  }
</script>

<!-- QR decoder -->
<script src="libs/jsqr.min.js"></script>

<script type="module">
  import init, {
    sha256_hash,
    aes_gcm_encrypt,
    aes_gcm_decrypt,
    argon2_derive
  } from "./wasm/memoro_crypto.js";

  window.initCryptoWasm = async () => {
    await init();
    window.sha256Hash       = (u8) => Promise.resolve(sha256_hash(u8));
    window.aesEncryptRust   = (k,n,p) => Promise.resolve(aes_gcm_encrypt(k,n,p));
    window.aesDecryptRust   = (k,n,c) => Promise.resolve(aes_gcm_decrypt(k,n,c));
    window.argon2DeriveRust = (pwdBytes, saltBytes, t, m, p, len) =>
      argon2_derive(pwdBytes, saltBytes, t, m, p, len);
  };
  window.initCryptoWasm();
</script>


  <link id="theme-cypherpunk" rel="stylesheet" href="css/dashboard_cypherpunk.css">
  <link id="theme-clean" rel="stylesheet" href="css/dashboard_clean.css" disabled>
<script>
  // Toggle dashboard styles + (later) matrix by theme
  function applyDashboardTheme(theme) {
    const cy = document.getElementById('theme-cypherpunk');
    const cl = document.getElementById('theme-clean');
    const isCypher = (theme === 'cypherpunk');

    // 1) Flip stylesheets (safe in <head>)
    if (cy) cy.disabled = !isCypher;
    if (cl) cl.disabled =  isCypher;

    // 2) Body attribute (only when body exists)
    const setBodyAttr = () => {
      if (document.body) {
        document.body.setAttribute('data-theme', isCypher ? 'cypherpunk' : 'clean');
      }
    };
    if (document.readyState === 'loading') {
      window.addEventListener('DOMContentLoaded', setBodyAttr, { once: true });
    } else {
      setBodyAttr();
    }

    // 3) Matrix control happens after DashboardMatrix is defined (bottom of file)
    if (window.DashboardMatrix) {
      if (isCypher) DashboardMatrix.start();
      else DashboardMatrix.stop();
    }
  }

  // Read saved theme and pre-flip stylesheets early (avoid FOUC). Body/matrix handled later.
   (function initDashboardTheme(){
const saved =
  sessionStorage.getItem('theme') ??
  localStorage.getItem('theme') ??
  'cypherpunk';
    window.__savedDashboardTheme = saved;

    const cy = document.getElementById('theme-cypherpunk');
    const cl = document.getElementById('theme-clean');
    const isCypher = (saved === 'cypherpunk');
    if (cy) cy.disabled = !isCypher;
    if (cl) cl.disabled =  isCypher;
  })();
</script>


</head>
<body>
  <div class="ui-frame" aria-hidden="true"></div>
  <input type="file" id="vaultZipInput" accept=".zip" style="display:none;" onchange="handleVaultZip(event)">
<div style="display: flex; justify-content: center;">
  <h1><span class="typewriter-text" style="animation-delay: 0s;">Memoro Vault</span></h1>
</div>
<div style="position: relative; width: 100%; display: flex; justify-content: center;">
  <p class="typewriter-text" style="animation-delay: 1.3s; margin-bottom: 0.3em; pointer-events: none;">
    What matters most.
  </p>
</div>
<div style="position: relative; width: 100%; display: flex; justify-content: center;">
  <p class="typewriter-text" style="animation-delay: 2.5s; margin-top: 0; pointer-events: none;">
    Hidden in plain sight.
  </p>
</div>


<div class="button-group">
  <button class="button" style="animation-delay: 3.5s;" onclick="promptOfflineWarning('create')">+ Create New Vault</button>
  <button class="button" style="animation-delay: 5.5s;" onclick="promptOfflineWarning('load')">Load Vault File</button>
  <button class="button" style="animation-delay: 9.5s;" onclick="openPaperDecrypt()">Restore Physical Backup</button>
  <button class="button" style="animation-delay: 7.5s;" onclick="goToHowItWorks()">How Memoro Works</button>
</div>

<div class="vault-list" id="vaultList"></div>

<!-- Unlock Vault Modal -->
<div class="modal-overlay" id="unlockModal">
  <div class="modal">
    <h2>Unlock Vault</h2>
    <h3 id="question1Label"></h3>
    <input type="text" id="answer1Input" placeholder="Answer 1">
    <h3 id="question2Label"></h3>
    <input type="text" id="answer2Input" placeholder="Answer 2">

    <!-- Lockout Visuals -->
    <div id="lockoutSection" style="display:none; width:100%; margin-top:10px; text-align:center;">
      <p id="lockoutTimerText" style="margin:5px 0; font-size:16px; color:#ccc;">Locked for 15s</p>
      <div style="background-color:#444; width:100%; height:10px; border-radius:5px; overflow:hidden;">
      <div id="lockoutProgress" style="background-color:#00ff99; width:100%; height:10px;"></div>
      </div>
    </div>

    <div class="modal-buttons">
      <button id="unlockButton" onclick="submitUnlock()">Unlock</button>
      <button onclick="cancelUnlock()">Cancel</button>
    </div>
  </div>
</div>

<!-- Offline Warning Modal -->
<div class="modal-overlay" id="offlineWarning">
  <div class="modal">
    <h2>Offline Mode Recommended</h2>
    <p>We recommend disabling your internet connection temporarily for maximum security.</p>
    <div class="modal-buttons">
      <button onclick="proceedAfterOfflineWarning()">Continue</button>
      <button onclick="cancelOfflineWarning()">Cancel</button>
    </div>
  </div>
</div>

<!-- Message Modal -->
<div class="modal-overlay" id="messageModal">
  <div class="modal">
    <h2 id="messageModalTitle">Title</h2>
    <p id="messageModalText">Message goes here.</p>
    <div class="modal-buttons">
      <button onclick="closeMessageModal()">OK</button>
    </div>
  </div>
</div>

<!-- Confirm Modal -->
<div class="modal-overlay" id="confirmModal">
  <div class="modal">
    <h2>Confirm</h2>
    <p id="confirmModalText">Are you sure?</p>
    <div class="modal-buttons">
      <button onclick="confirmNo()">No</button>
      <button onclick="confirmYes()">Yes</button>
    </div>
  </div>
</div>

<!-- Rename Vault Modal -->
<div class="modal-overlay" id="renameModal">
  <div class="modal">
    <h2>Rename Vault</h2>
    <input type="text" id="renameInput" placeholder="New vault name">
    <div class="modal-buttons">
      <button onclick="submitRename()">Rename</button>
      <button onclick="cancelRename()">Cancel</button>
    </div>
  </div>
</div>

<!-- Paper Decrypt Modal -->
<div class="modal-overlay" id="paperDecryptModal">
  <div class="modal" style="max-width: 720px;">
    <h2>Restore Physical Backup</h2>
    <p style="white-space: normal; text-align:left;">
        Upload the full PDF or individual page images. We’ll extract:<br>
        • 1× <code>MVKEY</code> (single key QR)<br>
        • 1× <code>MVHDR</code> (header) and all <code>MVCT</code> tiles (ciphertext)<br>
        Then we rebuild <code>memoro-lite.zip</code>.
      </p>


    <!-- File input -->
    <input id="paperFiles" type="file" accept=".pdf,image/*" multiple
           style="width:100%; margin-bottom:12px;">

<div class="paper-cam-box">
  <h3 class="paper-cam-title">Scan Key Shares (Optional)</h3>
  <p class="paper-cam-desc">
    If you prefer, aim the camera at an MVKEY QR (one at a time). We still recommend uploading a page/PDF for the tiles.
  </p>

  <!-- the video target the camera attaches to -->
  <video id="paperCam" playsinline class="paper-cam" style="display:none;"></video>

  <div class="modal-buttons paper-cam-actions">
    <button onclick="startKeyCam()">Start Camera</button>
    <button onclick="stopKeyCam()">Stop Camera</button>
    <button onclick="scanFromVideoOnce()">Scan Key</button>
  </div>
</div>

<div id="paperStatus" class="paper-status"></div>

    <div class="modal-buttons" style="margin-top:10px;">
      <button onclick="closePaperDecrypt()">Close</button>
      <button id="rebuildBtn" onclick="rebuildLiteFromPaper()" disabled>Rebuild Lite ZIP</button>
    </div>
  </div>
</div>

<script type="module" src="js/dashboard.js"></script>

</body>
</html>
